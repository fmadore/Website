<script lang="ts">
	import { onMount } from 'svelte';
	import SEO from '$lib/SEO.svelte';
	import PdfGenerator from '$lib/components/cv/PdfGenerator.svelte';
	import CVHeader from './components/CVHeader.svelte';
	import CVEducation from './components/CVEducation.svelte';
	import CVAppointments from './components/CVAppointments.svelte';
	import CVPublications from './components/CVPublications.svelte';

	// Lazy load components below the fold using $state
	let CVGrants = $state<any>();
	let CVAwards = $state<any>();
	let CVDigitalHumanities = $state<any>();
	let CVConferences = $state<any>();
	let CVEvents = $state<any>();
	let CVTeaching = $state<any>();
	let CVConsulting = $state<any>();
	let CVInvitedTalks = $state<any>();
	let CVMedia = $state<any>();
	let CVLanguages = $state<any>();
	let CVService = $state<any>();
	let CVAffiliations = $state<any>();
	let CVComputerSkills = $state<any>();
	let CVResearchExperience = $state<any>();

	let lazyLoadTrigger: HTMLDivElement;
	let componentsStartedLoading = $state(false);

	onMount(() => {
		// Use Intersection Observer to trigger loading when user scrolls near the lazy content
		const observer = new IntersectionObserver(
			(entries) => {
				if (entries[0].isIntersecting && !componentsStartedLoading) {
					componentsStartedLoading = true;
					loadComponents();
				}
			},
			{
				// Start loading when the trigger is 400px from entering the viewport
				rootMargin: '400px'
			}
		);

		if (lazyLoadTrigger) {
			observer.observe(lazyLoadTrigger);
		}

		return () => {
			observer.disconnect();
		};
	});

	function loadComponents() {
		// Load components in batches to avoid overwhelming the browser
		// Batch 1: Most important sections
		setTimeout(() => {
			Promise.all([
				import('./components/CVGrants.svelte').then((m) => (CVGrants = m.default)),
				import('./components/CVAwards.svelte').then((m) => (CVAwards = m.default)),
				import('./components/CVDigitalHumanities.svelte').then(
					(m) => (CVDigitalHumanities = m.default)
				)
			]);
		}, 100);

		// Batch 2: Conference and talks
		setTimeout(() => {
			Promise.all([
				import('./components/CVInvitedTalks.svelte').then((m) => (CVInvitedTalks = m.default)),
				import('./components/CVConferences.svelte').then((m) => (CVConferences = m.default)),
				import('./components/CVEvents.svelte').then((m) => (CVEvents = m.default))
			]);
		}, 200);

		// Batch 3: Experience sections
		setTimeout(() => {
			Promise.all([
				import('./components/CVTeaching.svelte').then((m) => (CVTeaching = m.default)),
				import('./components/CVResearchExperience.svelte').then(
					(m) => (CVResearchExperience = m.default)
				),
				import('./components/CVService.svelte').then((m) => (CVService = m.default))
			]);
		}, 300);

		// Batch 4: Final sections
		setTimeout(() => {
			Promise.all([
				import('./components/CVConsulting.svelte').then((m) => (CVConsulting = m.default)),
				import('./components/CVMedia.svelte').then((m) => (CVMedia = m.default)),
				import('./components/CVLanguages.svelte').then((m) => (CVLanguages = m.default)),
				import('./components/CVAffiliations.svelte').then((m) => (CVAffiliations = m.default)),
				import('./components/CVComputerSkills.svelte').then((m) => (CVComputerSkills = m.default))
			]);
		}, 400);
	}
</script>

<SEO
	title="Curriculum Vitae - Frédérick Madore"
	description="Curriculum Vitae of Frédérick Madore, detailing publications, communications, activities, and fieldwork."
/>

<!-- PDF Generator Button -->
<div class="flex justify-end mb-4 max-w-4xl mx-auto">
	<PdfGenerator />
</div>

<div id="cv-content" class="cv-container glass-card p-8 max-w-4xl mx-auto rounded-lg">
	<CVHeader />
	<div class="cv-section-wrapper">
		<CVEducation />
	</div>
	<div class="cv-section-wrapper">
		<CVAppointments />
	</div>
	<div class="cv-section-wrapper">
		<CVPublications />
	</div>
	
	<!-- Intersection Observer trigger - starts loading when user scrolls near here -->
	<div bind:this={lazyLoadTrigger} style="height: 1px;"></div>
	
	<!-- Show minimal placeholders while loading to prevent layout shift -->
	{#if !componentsStartedLoading}
		<div class="cv-section-placeholder"></div>
	{/if}
	
	{#if CVGrants}
		<div class="cv-section-wrapper">
			<CVGrants />
		</div>
	{/if}
	{#if CVAwards}
		<div class="cv-section-wrapper">
			<CVAwards />
		</div>
	{/if}
	{#if CVDigitalHumanities}
		<div class="cv-section-wrapper">
			<CVDigitalHumanities />
		</div>
	{/if}
	{#if CVInvitedTalks}
		<div class="cv-section-wrapper">
			<CVInvitedTalks />
		</div>
	{/if}
	{#if CVConferences}
		<div class="cv-section-wrapper">
			<CVConferences />
		</div>
	{/if}
	{#if CVEvents}
		<div class="cv-section-wrapper">
			<CVEvents />
		</div>
	{/if}
	{#if CVTeaching}
		<div class="cv-section-wrapper">
			<CVTeaching />
		</div>
	{/if}
	{#if CVResearchExperience}
		<div class="cv-section-wrapper">
			<CVResearchExperience />
		</div>
	{/if}
	{#if CVService}
		<div class="cv-section-wrapper">
			<CVService />
		</div>
	{/if}
	{#if CVConsulting}
		<div class="cv-section-wrapper">
			<CVConsulting />
		</div>
	{/if}
	{#if CVMedia}
		<div class="cv-section-wrapper">
			<CVMedia />
		</div>
	{/if}
	{#if CVLanguages}
		<div class="cv-section-wrapper">
			<CVLanguages />
		</div>
	{/if}
	{#if CVAffiliations}
		<div class="cv-section-wrapper">
			<CVAffiliations />
		</div>
	{/if}
	{#if CVComputerSkills}
		<div class="cv-section-wrapper">
			<CVComputerSkills />
		</div>
	{/if}
</div>

<style>
	/* Main CV container */
	.cv-container {
		box-shadow: var(--shadow-lg);
		transition: box-shadow var(--transition-duration-200) ease;
	}

	/* CV section wrappers with subtle glass effect */
	:global(.cv-section-wrapper) {
		background: linear-gradient(
			135deg,
			rgba(var(--color-primary-rgb), 0.02) 0%,
			rgba(var(--color-highlight-rgb), 0.01) 100%
		);
		border-radius: var(--border-radius-lg);
		padding: var(--spacing-4);
		margin-bottom: var(--spacing-4);
		border: 1px solid rgba(255, 255, 255, 0.1);
		transition: all var(--transition-duration-200) ease;
	}

	/* Remove bottom margin from sections inside wrappers */
	:global(.cv-section-wrapper > section) {
		margin-bottom: 0;
	}

	:global(.cv-section-wrapper:hover) {
		background: linear-gradient(
			135deg,
			rgba(var(--color-primary-rgb), 0.04) 0%,
			rgba(var(--color-highlight-rgb), 0.02) 100%
		);
		border-color: rgba(var(--color-primary-rgb), 0.2);
		box-shadow: var(--shadow-sm);
	}

	/* Enhanced section headings */
	:global(#cv-content h3) {
		color: var(--color-primary);
		border-color: rgba(var(--color-primary-rgb), 0.3);
		padding-bottom: var(--spacing-2);
		margin-bottom: var(--spacing-3);
		position: relative;
	}

	:global(#cv-content h3::after) {
		content: '';
		position: absolute;
		bottom: 0;
		left: 0;
		width: 3rem;
		height: 2px;
		background: var(--color-accent);
		border-radius: var(--border-radius-full);
	}

	/* Subsection headings */
	:global(#cv-content h4) {
		color: var(--color-text-emphasis);
		margin-top: var(--spacing-4);
		margin-bottom: var(--spacing-2);
	}

	/* Entry items with hover effect */
	:global(#cv-content .space-y-3 > div) {
		padding: var(--spacing-2);
		border-radius: var(--border-radius-md);
		transition: all var(--transition-duration-150) ease;
	}

	:global(#cv-content .space-y-3 > div:hover) {
		background: rgba(var(--color-primary-rgb), 0.03);
		transform: translateX(4px);
	}

	/* Year labels with accent styling */
	:global(#cv-content .font-semibold.text-nowrap) {
		color: var(--color-primary);
		font-weight: var(--font-weight-semibold);
	}

	/* Reduce spacing between items in lists - override space-y-3 utility */
	:global(.space-y-3 > * + *) {
		margin-top: var(--spacing-2) !important;
	}

	/* Links styling */
	:global(#cv-content a) {
		color: var(--color-primary);
		transition: all var(--transition-duration-150) ease;
	}

	:global(#cv-content a:hover) {
		color: var(--color-accent);
		text-decoration: underline;
	}

	/* Placeholder for lazy loading */
	.cv-section-placeholder {
		min-height: 100px;
		opacity: 0;
	}

	/* Print styles */
	@media print {
		/* Hide the PDF button when printing */
		:global(.pdf-generator-wrapper),
		:global(button[onclick*="print"]) {
			display: none !important;
		}

		/* Optimize for print */
		.cv-container {
			max-width: 100% !important;
			padding: 0.5in !important;
			margin: 0 !important;
			box-shadow: none !important;
			border-radius: 0 !important;
			background: var(--color-white) !important;
		}

		/* Remove glassmorphism effects */
		:global(.glass),
		:global(.glass-card),
		:global(.glass-panel),
		:global(.cv-section-wrapper) {
			background: var(--color-white) !important;
			backdrop-filter: none !important;
			border: none !important;
			box-shadow: none !important;
		}

		/* Remove hover effects and transitions */
		:global(#cv-content .space-y-3 > div:hover),
		:global(.cv-section-wrapper:hover) {
			background: var(--color-white) !important;
			transform: none !important;
			box-shadow: none !important;
		}

		/* Ensure good contrast */
		:global(body) {
			background: var(--color-white) !important;
			color: var(--color-black) !important;
		}

		/* Page breaks */
		:global(#cv-content section) {
			page-break-inside: avoid;
		}

		:global(#cv-content h3) {
			page-break-after: avoid;
		}

		/* Links */
		:global(#cv-content a) {
			color: var(--color-primary) !important;
			text-decoration: underline !important;
		}

		/* Remove unnecessary spacing */
		.mb-4 {
			margin-bottom: var(--spacing-2) !important;
		}
	}
</style>
